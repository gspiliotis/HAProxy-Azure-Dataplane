# Azure Service Discovery for HAProxy — Example Configuration
# Copy to config.yaml and adjust values. Use ${ENV_VAR} for secrets.

azure:
  subscription_id: "${AZURE_SUBSCRIPTION_ID}"
  # Optional: limit discovery to specific resource groups (empty = all)
  resource_groups: []
  credential_type: "default"  # Uses DefaultAzureCredential

tags:
  service_name_tag: "HAProxy:Service:Name"
  service_port_tag: "HAProxy:Service:Port"
  instance_port_tag: "HAProxy:Instance:Port"
  # Allowlist: instance must match ALL tags (AND logic)
  allowlist: {}
    # environment: "production"
  # Denylist: instance excluded if ANY tag matches (OR logic)
  denylist: {}
    # HAProxy:Exclude: "true"

haproxy:
  base_url: "http://localhost:5555"
  api_version: "v2"
  username: "admin"
  password: "${HAPROXY_DATAPLANE_PASSWORD}"
  timeout: 10
  verify_ssl: true
  backend:
    name_prefix: "azure"
    name_separator: "-"
    balance: "roundrobin"
    mode: "http"
  server_slots:
    base: 10
    growth_factor: 1.5
    growth_type: "linear"  # "linear" or "exponential"

  # ── AZ-aware routing ──────────────────────────────────────────────
  # Azure Availability Zone where this HAProxy instance runs (1, 2, or 3).
  # Omit or set to null to disable AZ-aware routing entirely.
  #
  # When set, servers are annotated based on AZ proximity:
  #   - Same AZ (or instance has no zone): no extra options (full weight)
  #   - Different AZ, no AZperc tag:       server marked as "backup"
  #   - With AZperc tag (1-99):            same AZ gets weight=(100-AZperc),
  #                                        diff AZ gets weight=AZperc
  #
  # All active servers always get a "cookie" value equal to the server name.
  #
  # availability_zone: 1

  # Tag name on Azure VMs/VMSS instances that carries the AZ weight percentage.
  # Value must be an integer 1-99. For example, AZperc=10 means:
  #   - Same-AZ servers get weight 90 (100-10)
  #   - Cross-AZ servers get weight 10
  # Default: "HAProxy:Instance:AZperc"
  #
  # az_weight_tag: "HAProxy:Instance:AZperc"

  # ── Per-service backend options ──────────────────────────────────
  # Extra properties merged into the Dataplane API create-backend payload
  # when a backend is first created. Keyed by the service name tag value
  # (i.e. the value of HAProxy:Service:Name on the Azure resources).
  #
  # Any valid Dataplane API backend field can be used here — common
  # examples include cookie stickiness, custom timeouts, and HTTP options.
  #
  # backend_options:
  #   # Enable cookie-based session stickiness for the "WebApp" service
  #   WebApp:
  #     cookie:
  #       name: "SRVID"
  #       type: "insert"
  #       indirect: true
  #       nocache: true
  #       httponly: true
  #   # Custom server/connect timeouts for the "API" service
  #   API:
  #     server_timeout: 60000
  #     connect_timeout: 5000

polling:
  interval_seconds: 30
  jitter_seconds: 5
  max_backoff_seconds: 300
  backoff_base_seconds: 5

logging:
  level: "INFO"
  format: "json"  # "json" or "text"
